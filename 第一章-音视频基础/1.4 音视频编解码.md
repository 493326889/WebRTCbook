## 1.4 音视频编解码

> 音视频在网络中传播，主要分为如下几个阶段：录制-编码-传输-解码-播放，音视频编解码发挥这不可忽视的作用，能够优化数据包大小，通常通过媒体采集设备采集的音视频频数据被编码后，可以极大的压缩数据，并且画质影响不大，通常用户对直播画面实时性要求很高，了解编码底层原理有助于优化直播流畅性。本节主要介绍常见的音视频编解码格式。

### 1.4.1 常见音频编码格式

音频编码是为了将 PCM 音频采样数据转换为音频码流， 优化网络传输效率。常见的格式有：FLAC、APE、WAV、Opus、MP3、WMA、AAC。

FLAC、APE、WAV 是属于无损编码格式，压缩率低，通常用于音质要求较高的音乐等内容; Opus、MP3、WMA、AAC 属于有损压缩格式，压缩率高利于网络传输; 其中 Opus、OGG 属于完全免费开源的编码格式。不同的编码格式特点也不尽相同，不同编码面向的使用场景不同，没有绝对的优劣。

下面详细介绍常见的编码格式：

1. FLAC

   FLAC 全称 Free Lossless Audio Codec，中文直译为自由无损音频压缩编码。无损也就是说当你将从音频 CD 上读取的音频数据文件压缩成 FLAC 格式后，你还可以再将 FLAC 格式的文件还原，而还原后的音频文件与压缩前的一模一样，没有任何损失。

   FLAC 是一款的自由音频压缩编码，其特点是可以对音频文件无损压缩。不同于其他有损压缩编码，如 MP3 、AAC，压缩后不会有任何音质损失，现在已被很多软件及硬件音频产品所支持，很多流行的音乐播放器默认的无损音频格式都是 FLAC。

   > 特点：无损压缩格式，体积较大，但是兼容性好，编码速度快，播放器支持广。

2. APE

   APE 是一种常见的无损音频压缩编码格式，APE 是其编码后的文件扩展名，该编码格式的名称是 Monkey's Audio。

   Monkey's Audio 压缩比高于其他常见的无损音频压缩格式，约在 55%上下，但编解码速度略慢。在搜寻回放位置时，如果文件压缩比过高，在配备较差的计算机会有延迟的现象。另外，由于它没有提供错误处理的功能，若发生文件损坏，损坏位置之后的数据有可能会丢失。

   Monkey's Audio 是开放源代码的免费软件，但因其授权协议并非自由软件而是准自由软件（Semi-free Software）而受到排挤。因为这意味着许多基于 GNU/Linux 的 Linux 发行包或是其他只能基于自由软件的操作系统不能将其收入。较之其他使用更自由的许可证的无损音频编码器（如 FLAC），受其他软件的支持也更少。

   > 特点：无损压缩格式，其体积比其它无损压缩格式较小，编码速度偏慢。

3. WAV

   WAV 全称 Waveform Audio File Format，是微软公司开发的一种声音文件格式，也叫波形声音文件，是最早的数字音频格式，被 Windows 平台及其应用程序广泛支持。

   WAV 格式支持许多压缩算法，支持多种音频位数、采样频率和声道，采用 44.1kHz 的采样频率，16 位量化位数，因此 WAV 的音质与 CD 相差无几，但 WAV 格式对存储空间需求太大不便于交流和传播。

   > 特点：无损压缩格式，体积十分大。

4. Opus

   Opus 是一个有损声音编码的格式，由 Xiph.Org 基金会开发，之后由 IETF 互联网工程任务组进行标准化，适用于网上低延迟的即时声音传输，标准格式定义于 RFC 6716 文件。Opus 格式是一个开放格式，使用上没有任何专利或限制。

   Opus 集成了两种声音编码的技术：以语音编码为导向的 SILK 和低延迟的 CELT。Opus 可以无缝调节高低比特率。在编码器内部它在较低比特率时使用线性预测编码在高比特率时候使用变换编码（在高低比特率交界处也使用两者结合的编码方式）。Opus 具有非常低的算法延迟（默认为 22.5 ms），非常适合用于低延迟语音通话的编码，像是网上上的即时声音流、即时同步声音旁白等等，此外 Opus 也可以透过降低编码码率，达成更低的算法延迟，最低可以到 5 ms。在多个听觉盲测中，Opus 都比 MP3、AAC 等常见格式，有更低的延迟和更好的声音压缩率。

   在 WebRTC 实现中，强制要求支持 Opus，也是其默认的音频编码格式。

   > 特点：有损压缩;可动态调节比特率，音频带宽和帧大小;开放免费、没有专利限制。

5. MP3

   MP3 的全称是 Moving Picture Experts Group Audio Layer III。由于这种压缩方式的全称叫 MPEG Audio Layer3，所以简称为 MP3。

   MP3 是利用 MPEG Audio Layer 3 的技术，将音乐以 1:10 甚至 1:12 的压缩率，压缩成容量较小的 file，换句话说，能够在音质丢失很小的情况下把文件压缩到更小的程度。而且还非常好的保持了原来的音质。

   正是因为 MP3 体积小，音质高的特点使得 MP3 格式几乎成为网上音乐的代名词。

   > 特点：有损压缩，压缩率高，文件体积小，最高比特率 320K

6. WMA

   WMA 的全称是 Windows Media Audio，是微软力开发的一种音频编码格式。一般情况下相同音质的 WMA 和 MP3 音频，前者文件体积较小，并且可以通过 DRM（Digital Rights Management）方案加入防止拷贝，或者加入限制播放时间和播放次数，甚至是播放机器的限制，可有力地防止盗版。

   > 特点：支持 DRM 防盗版，相比 MP3 格式压缩率更高

7. AAC

   AAC 全称 Advanced Audio Coding，是一种基于 MPEG-2 的有损数字音频压缩的专利音频编码标准，由 Fraunhofer IIS、杜比实验室、AT&T、Sony、Nokia 等公司共同开发。MPEG-4 标准  出台后，在原本的基础上加上了 PNS（Perceptual Noise Substitution）等技术，并提供了多种扩展工具。为了区别于传统的 MPEG-2 AAC 又称为 MPEG-4 AAC。其作为 MP3 的后继者而被设计出来，在相同的位元率之下，AAC 相较于 MP3 通常可以达到更好的声音质量。

   AAC 提供了低至 8 kHz 高至 96 kHz 的多种采样率、更高的比特深度(8, 16, 24, 32 bit)，并且支持 1 到 48 之间的任何声道数

   > 特点：目前最好的有损格式之一，压缩率高

### 1.4.2 常见视频编码格式

视频编码主要是为了将视频像素数据压缩成视频码流，以降低视频的大小，从而方便网络传输和存储。常见的格式有：MPEG-2、H.264、H.265、VP8、VP9。

1. MPEG-2

   MPEG-2 是 MPEG 工作组于 1994 年发布的视频和音频压缩国际标准，视频编码是 MPEG-2 标准的第二部分，其视频通常包含多个 GOP(Group Of Pictures)，每一个 GOP 包含多个帧（frame）。帧类型（frame type）通常包括 I-帧（I-frame）、P-帧（P-frame）和 B-帧（B-frame）。其中 I-帧采用帧内编码，P-帧采用前向估计，B-帧采用双向估计。通常 I 帧被称为关键帧，包含了完整的一帧图像。

   I 帧图像采用帧内编码方式，即只利用了单帧图像内的空间相关性，而没有利用时间相关性。I 帧使用帧内压缩，不使用运动补偿，由于 I 帧不依赖其它帧，所以是随机存取的入点，同时是解码的基准帧。I 帧主要用于接收机的初始化和信道的获取，以及节目的切换和插入，I 帧图像的压缩倍数相对较低。I 帧图像是周期性出现在图像序列中的，出现频率可由编码器选择。

   P 帧和 B 帧图像采用帧间编码方式，即同时利用了空间和时间上的相关性。P 帧图像只采用前向时间预测，可以提高压缩效率和图像质量。P 帧图像中可以包含帧内编码的部分，即 P 帧中的每一个宏块可以是前向预测，也可以是帧内编码。

   B 帧图像采用双向时间预测，可以大大提高压缩倍数。值得注意的是，由于 B 帧图像采用了未来帧作为参考，因此 MPEG-2 编码码流中图像帧的传输顺序和显示顺序是不同的。

2. H.264

   H.264，又称为 MPEG-4 第 10 部分，高级视频编码（英语：MPEG-4 Part 10, Advanced Video Coding，缩写为 MPEG-4 AVC）是一种面向块，基于运动补偿的视频编码标准 。到 2014 年，它已经成为高精度视频录制、压缩和发布的最常用格式之一。第一版标准的最终草案于 2003 年 5 月完成。该编码标准被广泛用于网络流媒体数据传输，在国内流媒体资源普遍采用该编码格式。

3. H.265

   高效率视频编码（High Efficiency Video Coding，简称 HEVC），又称为 H.265 和 MPEG-H 第 2 部分，是一种视频压缩标准，被视为是 ITU-T H.264/MPEG-4 AVC 标准的继任者。2004 年开始由 MPEG(ISO/IEC Moving Picture Experts Group)和 VCEG(ITU-T Video Coding Experts Group)作为 MPEG-H Part 2 或称作 ITU-T H.265 开始制定。第一版的 HEVC/H.265 视频压缩标准在 2013 年 4 月 13 日被接受为国际电信联盟（ITU-T）的正式标准。

   HEVC 被认为不仅提升视频质量，同时也能达到 H.264/MPEG-4 AVC 两倍之压缩率（等同于同样画面质量下位元率减少到了 50%），可支持 4K 清晰度甚至到超高清电视（UHDTV），最高清晰度可达到 8192×4320（8K 清晰度）。

4. VP8

   是开放免费的编码格式，是 Google 收购 On2 公司之后获得的软件，旨在提供免费的编码格式提供给 HTML5 使用，通常被封装在 webM 容器中传播。该编码很少有公司采用。

5. VP9

   VP9 是谷歌公司为了替换老旧的 VP8 视频编码格式并与动态专家图像组（MPEG）主导的高效率视频编码（H.265/HEVC）竞争所开发的免费、开源的视频编码格式。VP9 一般与 Opus 音频编码一起以 WebM 格式封装

   相比于 H.265，许多浏览器都支持 VP9 视频格式，截止 2018 年 6 月，约有 4/5 的浏览器（包括移动设备）支持 WebM 封装容器和 VP9 视频编码，例如: Chrome、Microsoft Edge、Firefox、Opera 等浏览器都内置了 VP9 解码器，可在 HTML5 播放器中播放 VP9 视频格式。Windows 10 操作系统也内置了 WebM 分离器和 VP9 解码器。
